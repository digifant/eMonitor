<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta http-equiv="expires" content="43200"/>
        <!--
            This website is powered by eMonitor
        -->
        <title>eMonitor</title>
        <meta name="generator" content="eMonitor" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="mobile-web-app-capable" content="yes">

        <link rel="stylesheet" href="/monitor/inc/monitor.min.css" />
        <link rel="stylesheet" href="/css/layout.min.css" />
        <link rel="stylesheet" href="/css/monitor_{{ theme }}.css"/>
        <script type="text/javascript" language="javascript" src="/js/jquery-1.11.0.min.js"> </script>
        <script type="text/javascript" language="javascript" src="/js/jquery-ui-1.10.1.min.js"> </script>
        <script type="text/javascript" language="javascript" src="/js/jquery.layout.min.js"> </script>
    </head>
    <body onload="JavaScript:TimedRefresh(3600000);">
        {{ content|safe }}
        {%- if footer == 1 %}
            <div class="footer">
                <div class="versiontext">
                    <small style="color:#ababab">{{ app_name }} <span>{{ app_version }}</span></small>
                    <small id="footermesg" style="color:#ababab"></small>
                </div>
                <div class="time" id="time"> </div>
            </div>
            <div class="version"> </div>
        {%- endif %}
        <script type="text/javascript">

            function zeroPad(num, places){
                var zero = places - num.toString().length + 1;
                return new Array(+(zero > 0 && zero)).join("0") + num;
            }
            function timestring() {
                var now = new Date();
                var minute  = zeroPad(now.getMinutes(),2);
                var second = zeroPad(now.getSeconds(),2);
                $('#time').html(now.getHours()+":"+minute+":"+second);
            }

            timestring();
            setInterval('timestring()', 1000);

            var loc = window.location;
            var ws_uri;
            if (loc.protocol == "https:") {
                ws_uri = "wss:";
            } else {
                ws_uri = "ws:";
            }
            ws_uri += "//" + loc.host + "/ws";
            var websocket;

            function TimedRefresh(t) {
                setTimeout("websocket.close(); location.reload(true);", t);
            }

            function changeParticipationListTable (detailed) {
                var oldTable = document.getElementById('participationListTable')
                var newTable = oldTable.cloneNode(true);
                var l3 = detailed['3'], l6 = detailed['6'], l9 = detailed['9'], l0 = detailed['0'];
                for (index = 0; index < l3.length; ++index) {
                  console.log(l3[index]);
                }
                oldTable.parentNode.replaceChild(newTable, oldTable);
            }

            function ConnectWs () {
                if ( (websocket == undefined) || (websocket.readyState > 2)  ) {
                    console.log (websocket);
                    websocket = new WebSocket (ws_uri);
                    websocket.onopen    = function (evt) { console.log("Connected to WebSocket server."); document.getElementById("footermesg").innerHTML = "WS connected"; };
                    websocket.onclose   = function (evt) { console.log("Disconnected"); document.getElementById("footermesg").innerHTML = "WS closed";};
                    websocket.onmessage = function (evt) {
                                    console.log('got Message: ' + evt.data);
                                    var json_obj = $.parseJSON(evt.data)
                                    if (json_obj["command"]== "reload") {
                                        console.log('reload command');
                                        websocket.close(); location.reload(true);
                                    }
                                    if (json_obj["command"] == "websocket_participation") {
                                      console.log('websocket_participation command');
                                      var detailed = json_obj['detailed'];
                                      //changeParticipationListTable (detailed);
                                    }
                                  };
                    websocket.onerror   = function (evt) { console.log('Error occured: ' + evt.data); document.getElementById("footermesg").innerHTML = "WS error occured"; };
                }
            }

            ConnectWs ();
            var timer = setInterval (ConnectWs, 10000);
        </script>
        {%- if activecount>1 %}
        <div id="activecount">
            <span>{{ position }}</span>/<span>{{ activecount }}</span>
        </div>
        {%- endif %}
    </body>
</html>
